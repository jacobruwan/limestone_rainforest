---
title: "model_development"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Research Question 1: SLA
In this analysis, SLA is investigated to quantify the difference between dominant species and between disturbed and pristine forest conditions.

```{r load_datasets}
dropbox <- "C:\\Users\\Jacob\\Dropbox\\Semester 2 2017\\MXB344\\Project\\Data\\"

# load(paste0(dropbox, "domseedlingcover_rq1.RData"))
# load(paste0(dropbox, "domshannons_rq1.RData"))
load(paste0(dropbox, "domsla_rq1.RData"))
# load(paste0(dropbox, "species_richness_rq3.RData"))
# load(paste0(dropbox, "hobo_rq2.RData"))
```

```{r}
sla.df <- domsla_rq1.df %>%
  mutate(transect = factor(transect),
         quadrat = factor(quadrat),
         dom_species_id = factor(dom_species_id)) %>%
  select(-av_dom_leaf_dry_weight, -start_hobo, -end_hobo, -min_rel_humid, -max_rel_humid, -species_id, -leaf_area)

sla.df %>% str()

library(lme4)
library(INLA)
```

```{r}
response <- "dom_sla"
predictors <- names(sla.df)[-(which(names(sla.df) %in% c("dom_sla", "transect", "quadrat")))]

possible_predictor_combinations <- list()
index <- 1

for (i in 1:length(predictors)) {
  for (j in 1:length(predictors)) {
  possible_predictor_combinations[[index]] <- i:j 
  index <- index + 1
  }
}

# Create formula's
formula_string_combinations <- list()

for (i in 1:length(possible_predictor_combinations)) {
  
  formula_string_combinations[[i]] <- predictors[possible_predictor_combinations[[i]][1]]
  
  if (length(possible_predictor_combinations[[i]]) > 1) {
    for (j in 2:length(possible_predictor_combinations[[i]])) {
      formula_string_combinations[[i]] <- paste(formula_string_combinations[[i]], 
                                                predictors[possible_predictor_combinations[[i]][j]],
                                                sep = " + ")
    }
  }
    
}
```

```{r all_inla_model_combinations}
# Run all INLA models
Log_Likelihood_Summary <- data.frame(Formula = "-", Log_Likelihood = NA)

for (i in 1:length(formula_string_combinations)) {
inla_formula <- as.formula(paste0("dom_sla ~ ",
                          formula_string_combinations[[i]],
                          " + f(transect, model='iid') + f(quadrat:transect, model = 'iid')"))

fit <- inla(inla_formula,
            family = "gaussian",
            data = sla.df)

Log_Likelihood_Summary <- Log_Likelihood_Summary %>%
  rbind(data.frame(Formula = formula_string_combinations[[i]],
                   Log_Likelihood = summary(fit)[["mlik"]][2]))

}


```

```{r}
# SiteP is significant. intercept -0.515, coefficient - 0.133
# Compare to gaussian glmm in fit2
fit.2 <- glmer(dom_sla ~ site + (1|transect/quadrat),
             data = sla.df,
             family = "gaussian")

summary(fit.2)

confint(fit.2)
```


```{r}


fit2 <- glmer(dom_abundance ~ site + (1|transect/quadrat),
             data = species_modelling.df,
             family = "poisson")

summary(fit2)




```

```{r}
# install.packages("INLA", repos="https://inla.r-inla-download.org/R/stable")
# options(repos = c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/testing"))
# update.packages("INLA")
library(INLA)
#### Fit the model via INLA
fit3 = inla(log(dom_shannon) ~ site + f(transect, model="iid") + f(quadrat:transect, model = "iid"),
            family="gaussian",
            data=quadrat_modelling.df)
summary(fit3)



#result = inla(formula,family="gaussian",data=data.full,control.compute =list(dic=TRUE, waic= TRUE, cpo = TRUE, mlik = TRUE,config=TRUE), control.predictor=list(compute=T))

```

