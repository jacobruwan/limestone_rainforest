---
title: "model_development"
output: html_document
---

```{r load_datasets_exploratory_analysis}
# This code should be removed when entire process is productionised
dropbox <- "C:\\Users\\Jacob\\Dropbox\\Semester 2 2017\\MXB344\\Project\\Data\\"

load(paste0(dropbox, "domseedlingcover_rq1.RData"))
load(paste0(dropbox, "domshannons_rq1.RData"))
load(paste0(dropbox, "domsla_rq1.RData"))
load(paste0(dropbox, "species_richness_rq3.RData"))
load(paste0(dropbox, "hobo_rq2.RData"))
```

This section provides an insight to the trends in the collected data. This analysis will be focused on individual research questions. This will provide interpretability when developing the statistical model.

## Research Question 1: Dominant Species Seedling Cover
```{r}
domseedlingcover_rq1.df

```

### Site vs Dominant Seedling Cover
In the figure below, we observe:

  * a slighty larger variance for domiannt species 1 and 2 in pristine sites.
  * higher IQR and medians for dominant species 1 and 2 in pristine sites
  * domiant species 3 is less evident in pristine sites
  * the coverage dominant species 4 is insignificant in comparison to the other 3
  
```{r}
domseedlingcover_rq1.df %>%
  select(dom_species_id, site, dom_seedling_cover, transect, quadrat) %>%
  distinct() %>%
  filter(!is.na(dom_species_id)) %>%
  ggplot(aes(x = factor(dom_species_id), y = dom_seedling_cover, col = site)) +
  geom_boxplot() +
  theme_project() +
  scale_colour_tableau() +
  ggtitle("Dominant Seedling Cover vs Site")

```




## Research Question 1: Dominant Species Shannons index of Diversity
```{r}
domshannons_rq1.df %>% str()
```

```{r}
domshannons_rq1.df %>%
  ggplot(aes(x = paste0(site,transect), y = dom_shannon)) +
  geom_point() +
  theme_project() +
  scale_colour_tableau() +
  ggtitle("Dominant Shannons Index vs Site")


```

  



## Research Question 1: Dominant Species Specific Leaf Area


  * leaf area - photosynthetic aparatus of the plant
  * amount of investment of dry matter (plant investment into growth defence trade off) -> Most dominant species most compettitive, higher specific leaf area

### Abundance-Weighted SLA vs Dominant Species ID
```{r}
domsla_rq1.df %>%
  ggplot(aes(x=dom_species_id, y = dom_sla_weighted_abundance, col=site)) +
  geom_boxplot() +
  theme_project() +
  scale_colour_tableau() +
  ggtitle("Weighted SLA vs Site and Dominant Species ID")+
  xlab("Dominant Species") +
  ylab("Abundance-Weighted SLA")

```


### Functional Diversity: Abundance vs SLA
```{r}
# dataq3 %>%
#   ggplot(aes(dom_sla, col = dom_species_id)) +
#   geom_density()

slagroup.df <- domsla_rq1.df %>%
  mutate(sla_group = cut(dom_sla,
                         breaks = seq(0, max(dom_sla), 25))) %>%
  group_by(dom_species_id, sla_group) %>%
  # summarise(sla_group_abundance = sum(dom_abundance)) %>% # Incorrect logic here.. since they all have the same abundance ata  quadrat level
  summarise(obs = n()) %>%
  mutate(index = as.numeric(sla_group)) %>%
  arrange(index)


slagroup.df %>%
  ggplot(aes(x=index, y = obs, fill = dom_species_id, col = dom_species_id)) +
  # geom_bar(stat = "identity", position = "dodge") +
  geom_point() +
  geom_smooth(span = 0.4) +
  theme_project() +
  theme(axis.text.x = element_text(angle = 45, 
                                   vjust = 1,
                                   hjust = 1))  +
  ggtitle("Functional Evenness of SLA for Dominant Species") +
  ylab("Number of Leaf Samples") +
  xlab("Bucketed SLA") +
  # scale_fill_tableau(name = "Dominant Species") +
  scale_colour_tableau(name = "Dominant Species") +
  scale_x_continuous(breaks = unique(slagroup.df$index),
                     labels = unique(slagroup.df$sla_group),
                     lim  = c(1, 15))
  

slagroup.df$index %>% unique

```

### SLA vs Species Richness
```{r}
domsla_rq1.df %>%
  ggplot(aes(x = species_richness, y = dom_sla_weighted_abundance, 
             col = site)) +
  geom_point(size = 1) +
  theme_project() +
  scale_colour_manual(name = "Site", values = colours.site) +
  ggtitle("Domiant Species: SLA vs Species Richness (12 Quadrats)") +
  xlab("Species Richness") +
  ylab("Abundance-Weighted SLA") +
  facet_wrap("dom_species_id")


```

### SLA vs Dominant Species Leaf Traits
```{r}
leaf_trait_choice <- "leaf_arrangement"

domsla_rq1.df %>%
  select(dom_sla)


```

## Research Question 2: Hobo Time Series
```{r}
# Create 6 hour intervals for time series graphs
start <- as.POSIXct(strptime("2017-09-25 04:00:00", "%Y-%m-%d %H:%M:%S"))
interval <- 60*6
end <- start + as.difftime(4, units="days")
labels = seq(from=start, by=interval*60, to=end)

# Filter the data between useable dates
datarq2 <- hobo_rq2.df # Ten Hour Lag..


# Get shading for different days
hobo_days <- data.frame(startday = c(as.POSIXct(strftime("2017-09-26 3:00:01", "%Y-%m-%d %H:%M:%S")),
                                     as.POSIXct(strftime("2017-09-26 00:00:00", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins"),
                                     as.POSIXct(strftime("2017-09-27 00:00:00", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins"),
                                     as.POSIXct(strftime("2017-09-28 00:00:00", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins")),
                        endday =   c(as.POSIXct(strftime("2017-09-25 23:59:59", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins"),
                                     as.POSIXct(strftime("2017-09-26 23:59:59", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins"),
                                     as.POSIXct(strftime("2017-09-27 23:59:59", "%Y-%m-%d %H:%M:%S"))+as.difftime(60*10, units="mins"),
                                     as.POSIXct(strftime("2017-09-28 22:00:00", "%Y-%m-%d %H:%M:%S")))) %>%
                        mutate(day = c("Monday", "Tuesday", "Wednesday", "Thursday"),
                               day = factor(day,
                                            levels = c("Monday", "Tuesday", "Wednesday", "Thursday"),
                                            ordered = TRUE)) %>% 
  tbl_df()

# Plot the graphs
ggplot() +
  theme_project() +
  scale_x_datetime(breaks = labels
                   # labels = labels
                   # limits = c(as.POSIXct(strptime("2017-09-25 18:00:00",
                   # "%Y-%m-%d %H:%M:%S")) + as.difftime(10, units="hours"),
                              # as.POSIXct(strptime("2017-09-28 12:00:00",
                   # "%Y-%m-%d %H:%M:%S")) + as.difftime(10, units="hours"))
                   ) +
  theme(axis.text.x = element_text(angle = 45, 
                                   vjust = 1,
                                   hjust = 1)) +
  geom_rect(aes(xmin=startday, xmax=endday, ymin = 25.8, ymax = 28, fill = day),
            data = hobo_days, alpha = 0.4)   +
  scale_fill_tableau(name = "Day")+
  # geom_line(aes(x=date_time, y=temp, col=hobo_id),
             # data = datarq2, size=1) +
  # scale_colour_pander(name = "Hobo ID")+
  geom_line(aes(x=date_time, y=temp, col=site),
             data = datarq2, size=1) +
  scale_colour_pander(name = "Site") +
  ggtitle("Temperature over Time") +
  xlab("Time of Day") +
  ylab("Temperature (Degrees Celsius)")

```











# Data
```{r}
# Use the choose files function to get the location of the datasets on your computer
# choose.files()

# Should get an output like:
# "C:\\Users\\Jacob\Project\\Data\\biotic_leaftraits.RData"

# Copy the folder spot below, and copy the """".RData file into the load function below

location <- "C:\\Users\\Jacob\\Dropbox\\Semester 2 2017\\MXB344\\Project\\Data\\"

# Load the datasets
load(paste0(location, "biotic_leaftraits.RData"))
load(paste0(location, "abiotic_filterpaper.RData"))
load(paste0(location, "abiotic_canopycover.RData"))
load(paste0(location, "abiotic_penetrometer.RData"))

```

## Abiotic
```{r}
# Decopmosition
ggplot(aes(x=site, y=decomposition),
       data = abiotic_filterpaper.df) + 
  geom_boxplot() +
  ggtitle("Abiotic Comparison") +
  theme_project()


# LAI
ggplot(aes(x=site, y=lai),
       data = abiotic_canopycover.df) + 
  geom_boxplot() +
  ggtitle("Abiotic Comparison") +
  theme_project()

# Gap fResction THreshold
ggplot(aes(x=site, y=gft),
       data = abiotic_canopycover.df) + 
  geom_boxplot() +
  ggtitle("Abiotic Comparison") +
  theme_project()

# Compaction
ggplot(aes(x=site, y=compaction),
       data = abiotic_penetrometer.df) + 
  geom_boxplot() +
  ggtitle("Abiotic Comparison") +
  theme_project()

```

## Number of Leaf Traits evident in each Quadrat
```{r}
leaf_trait_choice <- "leaf_arrangement"

for (leaf_trait_choice in names(biotic_leaftraits.df)[8:15]) {

count_data <- biotic_leaftraits.df %>%
  rename_("leaf_trait" = leaf_trait_choice) %>%
  group_by(site, leaf_trait) %>% # CHANGE LEAF TRAIT
  summarise(number_observations = n())%>%
  mutate(leaf_trait = ifelse(number_observations < 3, 
                             "Other (variety of uncommon)",
                             leaf_trait))  %>%
  arrange(desc(site), desc(number_observations)) %>%
  mutate(leaf_trait = factor(leaf_trait, 
                             levels = leaf_trait,
                             ordered = TRUE))

# CHANGE THE X VARIABLE LEAF TRAIT TO THE ONE ABOVE
p1 <- ggplot(aes(x=leaf_trait, y=number_observations, fill = site),
       data = count_data) + 
  geom_bar(stat = "identity", position = "dodge") +
  ggtitle(paste(leaf_trait_choice, "Comparison")) +
  theme_project() +
  scale_fill_manual(name = "Site", values = colours.site) +
  # coord_flip()
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1, vjust = 1)) +
  scale_y_continuous(breaks = seq(0, 30, 5)) +
  ylab("Number of Species") +
  xlab(leaf_trait_choice)

print(p1)
}

```


```{r}
leaf_trait_choice <- "leaf_arrangement"

count_data <- biotic_leaftraits.df %>%
  select(-transect, -quadrat) %>%
  distinct() %>%
  select(-dom_species_id, -species_name, -species_presence) %>%
  gather(leaf_trait, composition, -site, -species_id) %>%
  filter(leaf_trait != "other")

count_data %>%
  group_by(site, leaf_trait, composition) %>%
  summarise(obs = n()) %>%
  arrange(desc(obs)) %>%
  ggplot(aes(x = site, y = composition)) +
  geom_point() +
  facet_wrap("leaf_trait", scale="free_y")
  

# CHANGE THE X VARIABLE LEAF TRAIT TO THE ONE ABOVE
p1 <- ggplot(aes(y=leaf_trait, x=site, fill = site),
       data = count_data) + 
  geom_point()

print(p1)


```

```{r}
count_data %>%
  select(site, leaf_trait, composition) %>% 
  distinct() %>%
  ggplot(aes(x = site, y = composition)) +
  geom_point() +
  facet_wrap("leaf_trait", scale="free_y", nrow=4)

species_rawabiotic_modelling.df %>%
  select(site, leaf_arrangement) %>% 
  distinct() %>% arrange(leaf_arrangement)


biotic_leaftraits.df%>%
  select(site, leaf_arrangement) %>% 
  distinct()  %>% arrange(leaf_arrangement)

```

